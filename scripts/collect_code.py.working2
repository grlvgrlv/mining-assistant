import os
from datetime import datetime

def collect_code(root_dir, output_file, log_file, processed_file, missing_file):
    """Î£Ï…Î»Î»Î­Î³ÎµÎ¹ ÏŒÎ»Î± Ï„Î± Python, Shell, JSON, Config, Markdown, Log ÎºÎ±Î¹ TXT Î±ÏÏ‡ÎµÎ¯Î± Î±Ï€ÏŒ Ï„Î¿Î½ Î³Î¿Î½Î¹ÎºÏŒ Ï†Î¬ÎºÎµÎ»Î¿ ÎºÎ±Î¹ Ï„Î¿Ï…Ï‚ Ï…Ï€Î¿Ï†Î±ÎºÎ­Î»Î¿Ï…Ï‚ Ï„Î¿Ï… Î¼Îµ progress tracking, Î±Ï€Î¿Ï†ÎµÏÎ³Î¿Î½Ï„Î±Ï‚ Ï„Î¿Î½ Ï†Î¬ÎºÎµÎ»Î¿ venv ÎºÎ±Î¹ Î¬Î»Î»Î¿Ï…Ï‚ Î¬Ï‡ÏÎ·ÏƒÏ„Î¿Ï…Ï‚ Ï†Î±ÎºÎ­Î»Î¿Ï…Ï‚."""
    supported_extensions = [".py", ".sh", ".json", ".yaml", ".yml", ".toml", ".ini", ".cfg", ".md", ".log", ".txt"]
    excluded_dirs = {"venv", "node_modules", "__pycache__", ".git"}  # Î•Î¾Î±Î¯ÏÎµÏƒÎ· Ï„Î¿Ï… Ï†Î±ÎºÎ­Î»Î¿Ï… .git
    excluded_files = {".gitignore", "README", "old", "copy", "skipped_files", "processed_files", "missing_files"}  # Î•Î¾Î±Î¯ÏÎµÏƒÎ· ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ ÎºÎ±Î¹ logs

    max_file_size_mb = 10  # ÎœÎ­Î³Î¹ÏƒÏ„Î¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï… 10MB
    all_files = {os.path.join(root, file) for root, _, files in os.walk(root_dir) for file in files
                 if not any(excluded in root.split(os.sep) for excluded in excluded_dirs)
                 and not any(excluded in file for excluded in excluded_files)}  # Î•Î¾Î±Î¯ÏÎµÏƒÎ· ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½

    processed_files = set()
    skipped_files = []
    
    # Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± log Î±ÏÏ‡ÎµÎ¯Ï‰Î½
    with open(output_file, "w", encoding="utf-8") as outfile, open(log_file, "w", encoding="utf-8") as log, open(processed_file, "w", encoding="utf-8") as processed:
        outfile.write("# AI Mining Assistant - Institutional Memory\n")
        log.write("# Skipped Files Log\n")
        processed.write("# Processed Files Log\n")
        
        for file_path in sorted(all_files):
            root = os.path.dirname(file_path)
            file = os.path.basename(file_path)
            
            # Î‘Ï€Î¿Ï†Ï…Î³Î® Ï„Î¿Ï… Î´Î¹ÎºÎ¿Ï Ï„Î¿Ï… log Î±ÏÏ‡ÎµÎ¯Î¿Ï…
            if file_path in {output_file, log_file, processed_file, missing_file}:
                continue
            
            if os.path.getsize(file_path) > max_file_size_mb * 1024 * 1024:
                skipped_files.append(f"{file_path} - ÎœÎ­Î³ÎµÎ¸Î¿Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï… Î¼ÎµÎ³Î±Î»ÏÏ„ÎµÏÎ¿ Î±Ï€ÏŒ {max_file_size_mb}MB")
                continue
            
            # Î•Ï€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ Ï„Î¿ .env, Î±Î»Î»Î¬ ÏŒÏ‡Î¹ Ï„Î± Î¬Î»Î»Î± Î±ÏÏ‡ÎµÎ¯Î±
            if file.endswith(".env") or any(file.endswith(ext) for ext in supported_extensions):
                processed_files.add(file_path)
                print(f"[ğŸ”„] Processing {len(processed_files)}/{len(all_files)}: {file_path}", end="\r")
                
                outfile.write(f"\n# === File: {file_path} ===\n")
                outfile.write(f"# Path: {root}\n\n")
                try:
                    with open(file_path, "r", encoding="utf-8", errors="ignore") as infile:
                        outfile.write(infile.read())
                except Exception as e:
                    skipped_files.append(f"{file_path} - Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚: {e}")
                outfile.write("\n\n")
        
        # ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Ï„Ï‰Î½ Ï€Î±ÏÎ±Î»ÎµÎ¹Ï†Î¸Î­Î½Ï„Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½
        for skipped in skipped_files:
            log.write(skipped + "\n")
        for processed_path in processed_files:
            processed.write(processed_path + "\n")
    
    # ÎšÎ±Ï„Î±Î³ÏÎ±Ï†Î® Ï„Ï‰Î½ "Missing Files"
    missing_files = sorted(all_files - processed_files)
    with open(missing_file, "w", encoding="utf-8") as missing:
        missing.write("# Missing Files Log\n")
        for missing_file_path in missing_files:
            missing.write(missing_file_path + "\n")
    
    print(f"âœ… Î£Ï…Î»Î»Î¿Î³Î® Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Î¿Î»Î¿ÎºÎ»Î·ÏÏÎ¸Î·ÎºÎµ! ({len(processed_files)}/{len(all_files)}) - Î‘Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿ {output_file}")
    print(f"ğŸ“„ Î‘Î½Î±Ï†Î¿ÏÎ¬ Ï€Î±ÏÎ±Î»ÎµÎ¹Ï†Î¸Î­Î½Ï„Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿ {log_file}")
    print(f"ğŸ“„ Î‘Î½Î±Ï†Î¿ÏÎ¬ ÎµÏ€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¼Î­Î½Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿ {processed_file}")
    print(f"ğŸ“„ Î‘Î½Î±Ï†Î¿ÏÎ¬ Î±Î³Î½Î¿Î·Î¼Î­Î½Ï‰Î½ Î±ÏÏ‡ÎµÎ¯Ï‰Î½ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿ {missing_file}")

# ÎšÎ±Î¸Î¿ÏÎ¹ÏƒÎ¼ÏŒÏ‚ Ï„Î¿Ï… Î³Î¿Î½Î¹ÎºÎ¿Ï Ï†Î±ÎºÎ­Î»Î¿Ï…
ROOT_DIR = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))  # Î’ÏÎ¯ÏƒÎºÎµÎ¹ Ï„Î¿Î½ Î³Î¿Î½Î¹ÎºÏŒ Ï†Î¬ÎºÎµÎ»Î¿
SCRIPTS_DIR = os.path.join(ROOT_DIR, "scripts")
LOGS_DIR = os.path.join(ROOT_DIR, "logs")

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¼Î¿Î½Î±Î´Î¹ÎºÎ¿Ï Î¿Î½ÏŒÎ¼Î±Ï„Î¿Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï… log
timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
OUTPUT_FILE = os.path.join(LOGS_DIR, f"institutional_memory_{timestamp}.txt")
LOG_FILE = os.path.join(LOGS_DIR, f"skipped_files_{timestamp}.log")
PROCESSED_FILE = os.path.join(LOGS_DIR, f"processed_files_{timestamp}.log")
MISSING_FILE = os.path.join(LOGS_DIR, f"missing_files_{timestamp}.log")

if __name__ == "__main__":
    os.makedirs(LOGS_DIR, exist_ok=True)  # Î’ÎµÎ²Î±Î¹ÏÎ½ÎµÏ„Î±Î¹ ÏŒÏ„Î¹ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î¿ Ï†Î¬ÎºÎµÎ»Î¿Ï‚ logs
    collect_code(ROOT_DIR, OUTPUT_FILE, LOG_FILE, PROCESSED_FILE, MISSING_FILE)
